<link rel="import" href="../../../bower_components/polymer/polymer-element.html"/>

<!-- Components -->
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html"/>
<link rel="import" href="../../../bower_components/px-card/px-card.html"/>
<link rel="import" href="../../../bower_components/px-simple-bar-chart/px-simple-bar-chart.html"/>
<link rel="import" href="../../../bower_components/px-key-value-pair/px-key-value-pair.html"/>
<link rel="import" href="../../../bower_components/px-gauge/px-gauge.html"/>
<link rel="import" href="../../../bower_components/px-card/px-card.html"/>
<link rel="import" href="../../../bower_components/px-vis-timeseries/px-vis-timeseries.html"/>
<link rel="import" href="../../../bower_components/px-context-browser/px-context-browser.html"/>
<link rel="import" href="../../../bower_components/px-context-browser/px-context-browser-trigger.html"/>
<link rel="import" href="../../../bower_components/px-breadcrumbs/px-breadcrumbs.html"/>

<!-- Styles -->
<link rel="import" href="../../../css/app-shared-styles.html"/>
<link rel="import" href="../../../css/dashboard-view-styles.html"/>

<dom-module id="dashboard-view">
  <template>
    <style include="app-shared-styles"></style>
    <style include="dashboard-view-styles"></style>

    <!--
      Loads the asset data from  a fake "server", which is just a .json file on
      disk. Swap this URL for your the API service that returns your assets.
    -->
    <iron-ajax
        id="ajax"
        url="../../../sample-data/assets.json"
        handle-as="json"
        last-response="{{_assetItems}}">
    </iron-ajax>

    <!--
      The px-context-browser and px-breadcrumbs can be used in combination to
      provide both the traditional drilldown navigation as well as an
      interactive breadcrumb for quick navigation throughout the hierarchy.
      Place them both in a 'flex--row' container so that they appear next to
      each other in a container.
    -->
    <div class="context-browser-container shadow-navigation u-ph flex flex--row flex--middle">
      <px-context-browser-trigger trigger="{{openTrigger}}"></px-context-browser-trigger>
      <px-context-browser
          open-trigger="[[openTrigger]]"
          items="{{_assetItems}}"
          selected-route="{{_selectedAssetRoute}}"
          selected="{{_selectedAsset}}">
      </px-context-browser>
      <px-breadcrumbs
          class="flex__item"
          items="{{_assetItems}}"
          selected-route="{{_selectedAssetRoute}}"
          click-only-mode>
      </px-breadcrumbs>
    </div>

    <!--
      The dashboard title and several key-value pairs form a "spine", a design
      system pattern for high-level information shown about an asset at the
      top of a dashboard.
    -->
    <div class="spine u-pt">
      <span class="heading--page u-p">[[_selectedAsset.label]]</span>
      <div class="flex flex--wrap flex--justify">
        <px-key-value-pair
            class="u-p"
            key="Total alerts"
            value="[[_selectedAsset.data.alerts]]"
            size="beta">
        </px-key-value-pair>
        <px-key-value-pair
            class="u-p"
            key="Connected devices"
            value="[[_selectedAsset.data.connectedDevices]]"
            size="beta">
        </px-key-value-pair>
        <px-key-value-pair
            class="u-p"
            key="Utilization"
            value="[[_selectedAsset.data.utilization]]"
            uom="%"
            size="beta">
        </px-key-value-pair>
        <px-key-value-pair
            class="u-p"
            key="Faults"
            value="[[_selectedAsset.data.faults]]"
            size="beta">
        </px-key-value-pair>
        <px-key-value-pair
            class="u-p"
            key="Output"
            value="[[_selectedAsset.data.output]]"
            uom="MW"
            size="beta">
        </px-key-value-pair>
      </div>
    </div>


    <!-- This first px-card contains 4 kpis with bar charts and 4 gauges -->
    <px-card header-text="Productivity Details" icon="px-fea:alerts">
      <div slot="actions">
        <px-icon icon="px-utl:app-settings"></px-icon>
      </div>
      <div class="flex flex--wrap flex--justify">
        <div class="gauge-container u-p u-mb flex flex--col">
          <div class="flex u-mb">
            <px-key-value-pair key="Measured Output" value="110" uom="MW" size="delta"></px-key-value-pair>
            <px-simple-bar-chart class="u-ml++" width="100" height="50" chart-data='[ [112,57,53,122,128,120,56] ]' colors='["#8098FF"]'></px-simple-bar-chart>
          </div>
          <px-gauge class="gauge1" value="[[_selectedAsset.data.measurements.0]]" unit="%" normal='[ [0,100] ]' bar-width="20"></px-gauge>
        </div>
        <div class="gauge-container u-p u-mb flex flex--col">
          <div class="flex u-mb">
            <px-key-value-pair key="Measured Output" value="15" uom="MW" size="delta"></px-key-value-pair>
            <px-simple-bar-chart class="u-ml++" width="100" height="50" chart-data='[ [53,122,128,120,56,94,102] ]' colors='["#7BA662"]'></px-simple-bar-chart>
          </div>
          <px-gauge class="gauge2" value="[[_selectedAsset.data.measurements.1]]" unit="%" normal='[ [0,100] ]' bar-width="20"></px-gauge>
        </div>
        <div class="gauge-container u-p u-mb flex flex--col">
          <div class="flex u-mb">
            <px-key-value-pair key="Measured Output" value="121" uom="MW" size="delta"></px-key-value-pair>
            <px-simple-bar-chart class="u-ml++" width="100" height="50" chart-data='[ [53,122,128,120,56,94,102] ]' colors='["#E081C9"]'></px-simple-bar-chart>
          </div>
          <px-gauge class="gauge3" value="[[_selectedAsset.data.measurements.2]]" unit="%" normal='[ [0,100] ]' bar-width="20"></px-gauge>
        </div>
        <div class="gauge-container u-p u-mb flex flex--col">
          <div class="flex u-mb">
            <px-key-value-pair key="Measured Output" value="98" uom="MW" size="delta"></px-key-value-pair>
            <px-simple-bar-chart class="u-ml++" width="100" height="50" chart-data='[ [53,122,128,120,56,94,102] ]' colors='["#E9A24B"]'></px-simple-bar-chart>
          </div>
          <px-gauge class="gauge4" value="[[_selectedAsset.data.measurements.3]]" unit="%" normal='[ [0,100] ]' bar-width="20"></px-gauge>
        </div>
      </div>
    </px-card>

    <!-- This last px-card includes a px-vis-timeseries chart -->
    <px-card class="light-card" header-text="Exhaust TC Differentials" icon="px-fea:orchestration">
      <div slot="actions">
        <px-icon icon="px-utl:app-settings"></px-icon>
      </div>
      <div class="chart-container">
        <px-vis-timeseries
            debounce-resize-timing="250"
            chart-horizontal-alignment="center"
            chart-vertical-alignment="center"
            register-config='{"type":"horizontal"}'
            chart-data="[[_chartData]]"
            series-config='{"y0":{"name":"TC01-TTXM","x":"timeStamp","y":"y0","yAxisUnit":"C"},"y1":{"name":"TC02-TTXM","x":"timeStamp","y":"y1","yAxisUnit":"C"},"y2":{"name":"TC03-TTXM","x":"timeStamp","y":"y2","yAxisUnit":"C"},"y3":{"name":"TC04-TTXM","x":"timeStamp","y":"y3","yAxisUnit":"C"}}'
            chart-extents='{"x":["dynamic","dynamic"],"y":["dynamic","dynamic"]}'
            x-axis-config='{"title":"Date"}'
            y-axis-config='{"title":"Temperature","titleTruncation":false,"unit":"C"}'>
        </px-vis-timeseries>
      </div>
    </px-card>
  </template>
  <script>
    {
      class DashboardView extends Polymer.Element {
        static get is() { return 'dashboard-view'; }

        static get properties() {
          return {
            /** Assets to display in the context browser and breadcrumbs */
            _assetItems: {
              type: Array,
              observer: '_selectInitialAsset'
            },
            /** The selected asset. Will be used to load the data to show in the dashboard. */
            _selectedAsset: {
              type: Object,
              observer: '_loadAssetData'
            },
            _selectedAssetRoute: Array,
            _chartData: Array
          };
        }

        connectedCallback() {
          super.connectedCallback();

          Polymer.RenderStatus.afterNextRender(this, () => {
            // Wait until next render to load assets so we don't block
            // render with the network request.
            if (!this.alertItems) {
              this.$.ajax.generateRequest();
            }
          });
        }

        _selectInitialAsset(nextAssets, lastAssets) {
          if (nextAssets && !lastAssets && !this.selectedAssetRoute) {
            // When the assets are first loaded, select a default asset.
            // This function chooses a hard-coded asset, but you could
            // load the user's last selected asset from the database instead.
            this._selectedAssetRoute = ['North_America', 'United_States', 'Nevada', 'Reno_Plant_2', 'XY12367'];
          }
        }

        _loadAssetData() {
          // Loads data from a fake "server" (.json file on disk) when
          // an asset is selected. Loads the same data regardless of which
          // asset is selected.
          //
          // Swap this code out with logic to load data from a real server
          // with the ssset ID in the reqest params.
          const ajax = document.createElement('iron-ajax');
          ajax.url = '../../sample-data/dashboard-timeseries.json';
          ajax.addEventListener('response', e => {
            this._chartData = e.detail.response;
          });
          ajax.generateRequest();
        }
      }
      window.customElements.define(DashboardView.is, DashboardView);
    }
  </script>
</dom-module>
